name: Optimized Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # Security scan job (runs first)
  security-scan:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node
        with:
          node-version: '18'

      - name: Run security scan
        uses: ./.github/actions/security-scan
        with:
          scan-dependencies: 'true'
          scan-code: 'true'

  # Parallel jobs for better performance
  setup-and-build:
    runs-on: ubuntu-latest
    environment: production
    needs: security-scan
    outputs:
      web-build-available: ${{ steps.build.outputs.available }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node
        with:
          node-version: '18'

      - name: Setup Firebase
        uses: ./.github/actions/setup-firebase
        with:
          environment: 'production'
          firebase-project: ${{ secrets.FIREBASE_PROJECT_ID }}
          firebase-token: ${{ secrets.FIREBASE_TOKEN }}

      - name: Build web application
        id: build
        uses: ./.github/actions/build-web
        with:
          configuration: 'production'
          upload-artifact: 'true'

  # Parallel deployment jobs
  deploy-web:
    runs-on: ubuntu-latest
    needs: setup-and-build
    if: needs.setup-and-build.outputs.web-build-available == 'true'
    steps:
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build-production
          path: web-build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: web-build
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy production build to GitHub Pages'

  deploy-firebase:
    runs-on: ubuntu-latest
    needs: setup-and-build
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node
        with:
          node-version: '18'

      - name: Setup Firebase
        uses: ./.github/actions/setup-firebase
        with:
          environment: 'production'
          firebase-project: ${{ secrets.FIREBASE_PROJECT_ID }}
          firebase-token: ${{ secrets.FIREBASE_TOKEN }}

      - name: Deploy Firebase services
        working-directory: vaspitac-app/firebase
        run: |
          # Deploy Firestore rules and indexes
          firebase deploy --only firestore:rules,firestore:indexes --config firebase.prod.json --token "${{ secrets.FIREBASE_TOKEN }}"
          
          # Deploy Storage rules
          firebase deploy --only storage --config firebase.prod.json --token "${{ secrets.FIREBASE_TOKEN }}"
          
          # Deploy Functions if they exist
          if [ -d "functions" ]; then
            firebase deploy --only functions --config firebase.prod.json --token "${{ secrets.FIREBASE_TOKEN }}"
          fi

  # Final verification job
  verify-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-firebase]
    steps:
      - name: Verify deployment
        run: |
          echo "üöÄ Production deployment completed successfully!"
          echo "üì± Production site: https://vladimirvasilijevic.github.io/Kids-5-Minute-Activity-App/"
          echo "‚ö†Ô∏è  Remember to configure Firebase API key restrictions for this domain" 